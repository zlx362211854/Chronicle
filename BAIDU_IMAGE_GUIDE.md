# 🖼️ 百度图片搜索功能说明

## 功能概述

项目已集成百度图片搜索API，可以在生成章节时自动搜索并下载相关图片。

## 工作原理

1. **AI生成占位符**：DeepSeek在生成章节时，会在合适位置插入图片占位符
2. **提取占位符**：系统自动提取所有图片占位符
3. **搜索图片**：使用百度图片搜索API根据关键词搜索相关图片
4. **下载图片**：自动下载图片到本地 `images/` 目录
5. **显示图片**：图片在章节中正常显示

## 配置说明

在 `config/config.json` 中配置：

```json
{
  "images": {
    "enabled": true,           // 是否启用图片功能
    "image_dir": "images",     // 图片存储目录
    "auto_download": true,      // 是否自动下载图片
    "search_source": "baidu"   // 图片搜索源（目前支持baidu）
  }
}
```

## 百度图片搜索API

使用的API接口：
```
https://image.baidu.com/search/acjson?tn=resultjson_com&word=关键词&pn=页数&rn=每页数量
```

### API参数说明

- `tn`: 固定值 `resultjson_com`
- `word`: 搜索关键词（URL编码）
- `pn`: 页码偏移量（从0开始，每页30张）
- `rn`: 每页返回数量（默认30）

### 返回数据格式

API返回JSON格式，包含以下字段：
- `data`: 图片数据数组
  - `replaceUrl`: 高质量图片URL（优先使用）
  - `middleURL`: 中等质量图片URL
  - `thumbURL`: 缩略图URL
  - `hoverURL`: 悬停图片URL
  - `width`: 图片宽度
  - `height`: 图片高度
  - `type`: 图片类型（jpg/png等）

## 使用流程

### 1. 生成章节

运行生成脚本：
```bash
python scripts/generate_chapter.py
```

### 2. AI插入图片占位符

DeepSeek会在内容中插入类似这样的占位符：
```markdown
![春秋时期的诸侯争霸场景](images/chapter_01_image_1.jpg)
![齐桓公画像](images/chapter_01_image_2.jpg)
```

### 3. 自动搜索和下载

系统会：
1. 提取图片描述作为搜索关键词
2. 调用百度图片搜索API
3. 获取第一张相关图片
4. 下载到本地 `chapters/chapter_XX/images/` 目录

### 4. 图片显示

图片会自动显示在章节中。

## 文件结构

```
chapters/
├── chapter_01/
│   ├── README.md              # 章节内容（包含图片引用）
│   └── images/                # 图片目录
│       ├── chapter_01_image_1.jpg
│       ├── chapter_01_image_2.jpg
│       └── ...
```

## 搜索关键词策略

系统会按以下优先级提取搜索关键词：

1. **图片描述**：从占位符的描述中提取
   - 例如：`![春秋时期的诸侯争霸场景]` → `春秋时期的诸侯争霸场景`

2. **章节关键词**：如果描述为空，使用章节的第一个关键词
   - 例如：`["周天子东迁", "齐桓公", ...]` → `周天子东迁`

3. **默认关键词**：如果都没有，使用 `历史`

## 示例

### 生成的内容

```markdown
# 第一章：抢戏的配角们——诸侯不"侯"，天子在打酱油

春秋时期，周天子从"天下共主"混成了需要诸侯"众筹"接济的"吉祥物"...

![春秋时期的诸侯争霸场景](images/chapter_01_image_1.jpg)

郑庄公第一个跳出来"霸凌"老板，一箭射穿了周天子的权威...

![郑庄公射箭场景](images/chapter_01_image_2.jpg)
```

### 自动处理过程

1. 检测到2个图片占位符
2. 搜索关键词1：`春秋时期的诸侯争霸场景`
3. 搜索关键词2：`郑庄公射箭场景`
4. 从百度下载相关图片
5. 保存到 `chapters/chapter_01/images/`

## 注意事项

### 1. 图片质量

- 百度图片搜索返回的图片质量可能参差不齐
- 系统优先使用 `replaceUrl`（高质量图片）
- 如果没有，则使用 `middleURL`（中等质量）

### 2. 版权问题

- 百度图片搜索返回的图片可能涉及版权
- 建议：
  - 仅用于个人学习项目
  - 商业用途需要获得授权
  - 可以替换为无版权图片

### 3. 网络要求

- 需要能够访问百度图片搜索API
- 下载图片需要稳定的网络连接

### 4. 搜索准确性

- 搜索关键词的质量影响图片相关性
- 建议在图片描述中包含具体的历史人物、事件名称
- 例如：`齐桓公` 比 `春秋人物` 更准确

## 故障排查

### 图片搜索失败

1. **检查网络连接**：确保可以访问百度图片搜索
2. **检查关键词**：关键词可能包含特殊字符，需要URL编码
3. **查看日志**：检查错误信息

### 图片下载失败

1. **检查URL有效性**：某些图片URL可能已失效
2. **检查文件权限**：确保有写入权限
3. **检查磁盘空间**：确保有足够空间

### 图片不显示

1. **检查文件路径**：确保图片文件存在
2. **检查文件名**：确保文件名匹配
3. **检查Markdown语法**：确保图片语法正确

## 优化建议

### 1. 关键词优化

在章节规划中，确保关键词具体、有画面感：
```json
{
  "keywords": ["周天子东迁", "齐桓公", "晋文公", "春秋五霸"]
}
```

### 2. 图片描述优化

让AI生成更具体的图片描述：
- ✅ 好：`春秋时期的诸侯争霸场景`
- ❌ 差：`图片`

### 3. 手动替换

如果自动下载的图片不合适，可以：
1. 手动下载合适的图片
2. 替换 `images/` 目录中的文件
3. 保持文件名不变

## 未来改进

- [ ] 支持多张图片选择（不只是第一张）
- [ ] 支持图片质量筛选
- [ ] 支持其他图片源（Unsplash、Pexels等）
- [ ] 支持图片缓存，避免重复下载
- [ ] 支持图片压缩优化

---

**提示**：百度图片搜索API是公开接口，无需API密钥，可以直接使用。但请注意遵守相关使用条款。

